# 프로젝트 직관하기 딱 좋은 날씨구만~

통합 야구 정보 확인 웹서비스

계기 : 야구를 직관할 때 직관에 관한 정보를 찾는 것이 어려워(날씨, 지역, 예매) 그런 것들을 한데 모아 
제공하는 서비스가 있으면 좋겠다고 생각을 했습니다

<br/><br/>

## 제공하는 서비스 
1. 팀 선택 후 팀의 경기 일정 및 정보 제공
   1. 검색일 기준 10일까지의 경기는 상세 정보 제공
   2. 이후 경기는 달력의 형태로 간략하게 제공


<br/><br/>
<br/><br/>

###  팀 선택 후 팀의 경기 일정 및 정보 제공
1. 10일까지의 경기 상세 정보
   1. 상대팀 정보(이름, 로고, 상대전적)
   1. 경기 지역(원정, 홈) 
   2. 지역의 날씨 예보
   3. 예매 링크(인터파크, 티켓링크)

2. 10일 이후의 간략하게 제공 
   1. 상대팀 정보(이름, 로고, 상대전적)
   2. 경기 지역(원정, 홈)

### 구현해야할 API
- [ ] 팀 경기 일정 검색 API

### 구현해야할 기능
- [x] 팀 경기 일정 검색
- [ ] 상대 전적 검색
- [ ] 예매 주소 매칭
- [x] 경기장 날씨 저장


<br/><br/><br/><br/>

### 고민 지점
1. 날씨 데이터의 업데이트 방식
* 기상청중기예보 API는 조회한 날의 +3일~ +10일간의 날씨와 강수확률을 알려줌
* 날씨 데이터는 매일 조회해서 업데이트할 예정
* 겹치는 날짜의 날씨를 업데이트할 때 업데이트를 할지, 데이터를 삭제 후 새 데이터를 삽입할지에 대한 고민


2. 날씨 - 경기장 - 경기 - 구단의 관계

3. 매일 업데이트해야하는 정보
   1. 날씨
   2. 상대전적

### Trouble shooting
### 1. 쿼리 과생성 문제
* `현상`  단순 findBy 메서드 하나를 사용하였는데 두번씩 쿼리가 나감 
* `원인`  @ToString 어노테이션이 지연 로딩으로 설정된 필드를 호출함
* `해결`  @ToString의 exclude 옵션 사용

### 2. 1+N 문제
* `현상` 팀이름으로 경기 검색 시  gameTeamList 조회: 1번 쿼리
* `원인` Game - GameTeam 지연 로딩(Lazy Loading)설정 인한 N+1 쿼리 문제
* `해결` JPQL의 Fetch join을 사용하여 해결
* ```@Query("SELECT g FROM game g WHERE g.location LIKE %:location% AND DATE(g.gameTime) = :targetDate")```

### 3. 날씨 업데이트 로직 설계
* 매일 날씨를 업데이트하는데 업데이트 방식을 기존 DB 삭제 후 갱신 vs  겹치는 날짜만 업데이트

#### DB 삭제 후 갱신
* `장점` 기존 데이터가 남지 않으므로 데이터 정합성 유지가 쉬움 (삭제 후 새로 넣으면 항상 최신 상태)
  불필요한 데이터 정리 가능 (예전 경기의 날씨 데이터 제거)
  코드가 간단함 (삭제 후 insert)
* `단점`
매일 모든 데이터를 삭제 후 다시 삽입해야 해서 DB 부하가 큼
  트랜잭션 처리 중 오류 발생 시 일부 데이터만 삭제되고 남는 경우 문제 발생 가능
  경기와 연결된 날씨 데이터도 삭제되므로 경기 정보와의 연속성이 깨질 위험

#### 겹치는 날짜만 업데이트
* `장점`
  최소한의 데이터만 수정하므로 DB 부하를 줄일 수 있음 (대량 DELETE 필요 없음)
  기존 경기와의 연결 관계 유지 가능
  필요한 데이터만 업데이트하여 트랜잭션 안정성 증가
* `단점`
  기존 데이터를 조회 후 업데이트해야 하므로 조회 비용 발생
  예전 데이터를 직접 삭제하지 않으면 쌓일 가능성이 있음 → 보관 기간을 정해 일정 기간 지난 데이터 삭제 필요

**결론**

api를 통해 가져오는 데이터가 많지 않음(구장 9개의 7일치 날씨를 가져오는게 전부)
대부분 이전에 저장된 데이터와 큰 차이 없이 유지됨
따라서 변경 가능성이 있는 범위만 조회 및 업데이트하면 I/O 비용을 줄일 수 있을 거라고 판단

